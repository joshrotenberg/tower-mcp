name: Deploy Demo Server

on:
  push:
    branches:
      - main
    paths:
      - 'examples/crates-mcp/**'
      - 'src/**'
      - 'Cargo.toml'
      - '.github/workflows/deploy-demo.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Fly.io
    runs-on: ubuntu-latest
    # Only deploy if FLY_API_TOKEN is set
    if: github.repository == 'joshrotenberg/tower-mcp'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io
        run: flyctl deploy --config examples/crates-mcp/fly.toml --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Verify deployment
        run: |
          echo "Waiting for server to be ready..."
          sleep 10

          # Save response headers to a file so we can extract session ID
          echo "Sending initialize request..."
          INIT_RESPONSE=$(curl -s -D /tmp/headers.txt -X POST https://crates-mcp-demo.fly.dev/ \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -d '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2025-11-25","capabilities":{},"clientInfo":{"name":"deploy-check","version":"1.0"}}}')

          echo "Init response: $INIT_RESPONSE"

          # Extract session ID from response headers
          SESSION_ID=$(grep -i "mcp-session-id" /tmp/headers.txt | cut -d' ' -f2 | tr -d '\r')

          echo "Session ID: $SESSION_ID"

          if [ -z "$SESSION_ID" ]; then
            echo "Failed to get session ID"
            exit 1
          fi

          # Send initialized notification (required by MCP protocol before other requests)
          echo "Sending initialized notification..."
          curl -s -X POST https://crates-mcp-demo.fly.dev/ \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -H "MCP-Session-Id: $SESSION_ID" \
            -d '{"jsonrpc":"2.0","method":"notifications/initialized"}'

          echo "Sending test tool call..."
          TOOL_RESPONSE=$(curl -s -X POST https://crates-mcp-demo.fly.dev/ \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -H "MCP-Session-Id: $SESSION_ID" \
            -d '{"jsonrpc":"2.0","id":2,"method":"tools/call","params":{"name":"search_crates","arguments":{"query":"tower"}}}')

          echo "Tool response: $TOOL_RESPONSE"

          # Check for successful response (should contain "result" not "error")
          if echo "$TOOL_RESPONSE" | grep -q '"result"'; then
            echo "Deployment verification successful!"
          else
            echo "Deployment verification failed - unexpected response"
            exit 1
          fi
